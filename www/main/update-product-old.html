<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <header>
        <h2>Мой товар</h2>
    </header>
    <main>
        
        <div class="update-product-images">
            <!--
            <img src="image.jpg" alt="">
            <img src="image.jpg" alt="">
            <img src="image.jpg" alt="">
            <img src="image.jpg" alt="">
            <img src="image.jpg" alt="">
            -->
        </div>
        
        <div class="update-product-box">
            <div class="key">Title</div>
            <div class="value" id="titleInp" contenteditable>Bmw product</div>
        </div>
        <div class="update-product-box">
            <div class="key">Description</div>
            <pre class="value" id="descriptionInp" contenteditable>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Cumque odio maiores reiciendis, quibusdam nostrum laborum quas, saepe. Veritatis, sunt, ad, cupiditate enim officia qui id explicabo, in ratione harum quo!</pre>
        </div>
        <div class="update-product-box">
            <div class="key">Price</div>
            <input class="value" id="priceInp" type="number" value=39>
        </div>
        <div class="update-product-button">Update</div>
        
    </main>

<script src="config.js"></script>
<script src="js/script.js"></script>
<script>
    var updateButton = document.querySelector(".update-product-button")
    var imagesList = document.querySelector(".update-product-images")
    var values = document.querySelectorAll(".value")
    var titleInp = document.getElementById("titleInp")
    var descriptionInp = document.getElementById("descriptionInp")
    var priceInp = document.getElementById("priceInp")
    var accessToken = localStorage.getItem("accessToken")
    var products = JSON.parse(sessionStorage.getItem("products"))
    var updateProductId = sessionStorage.getItem("update_product_id")
    var edited = false
    var product = null
    
    if (accessToken == null) {location.replace("../login.html")}
    if (updateProductId == null) {location.replace("my-products.html")}
    if (products == null) {
        fetch(baseUrl+"/products", {method: "GET", headers: {"Content-Type": "application/json", "authorization": `Bearer ${accessToken}`}})
        .then(res => res.json())
        .then(data => {sessionStorage.setItem("products", JSON.stringify(data))})
    }
    
    var products = JSON.parse(sessionStorage.getItem("products"))
    for (let i of products) {
        if (i.id == updateProductId) {product = i}
    }
    
    product.images.forEach((image) => {
        var imageBox = document.createElement("img")
        imageBox.src = baseUrl+image.image
        imagesList.appendChild(imageBox)
    })
    titleInp.textContent = product.title
    descriptionInp.textContent = product.description
    priceInp.value = product.price
    
    values.forEach((value) => {
        value.addEventListener("input", () => {
            edited = true
            updateButton.style.display = "block"
        })
    })
    /*
    imagesList.forEach((image) => {
        image.addEventListener("click", () => {
            var deletePhoto = confirm("Delete photo?")
            if (deletePhoto) {console.log("Delete with path or id")}
        })
    })
    */
    updateButton.addEventListener("click", () => {
        var sure = confirm("Are you sure?")
        if (sure) {
            fetch(baseUrl+"/products/", {
                method: "PUT",
                headers: {"Content-Type": "application/json", "authorization": `Bearer ${accessToken}`},
                body: JSON.stringify({
                    product_id: updateProductId,
                    title: titleInp.textContent,
                    description: descriptionInp.textContent,
                    price: priceInp.value
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.code == "user_not_found") {location.replace("../login.html")}
                console.log(data)
                if (data.status == false) {
                    customErrorAlert("Some Error")
                }
                else {history.back()}
            })
        }
    })
    
</script>
</body>
</html>